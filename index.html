<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1">

        <title>Pull Request Dashboard</title>
        <link rel="stylesheet" href="https://netdna.bootstrapcdn.com/bootstrap/3.1.1/css/bootstrap.min.css">
        
        <style>
            tr.pull td.number {
                text-align: right;
            }
            tr.pull td.requester {
                white-space: nowrap;
            }
            th.approve,
            th.verify,
            tr.pull td.approve,
            tr.pull td.verify {
                text-align: center;
            }
            .gravatar {
                position: relative;
                vertical-align: middle;
                top: -1px;
                margin-right: 2px;
                border-radius: 2px;
            }
        </style>
    </head>

    <body>
        <div class="navbar navbar-default navbar-static-top" role="navigation">
            <div class="container-fluid">
                <div class="navbar-header">
                    <a class="navbar-brand" href="#">Pull Request Dashboard</a>
                </div>
                <ul class="nav navbar-nav" id="repos"></ul>
                <ul class="nav navbar-nav navbar-right" id="auth"></ul>
            </div>
        </div>
        
        <div class="modal fade" id="auth-modal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <form role="form">
                        <div class="modal-header">
                            <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                            <h4 class="modal-title" id="myModalLabel">Connect to GitHub</h4>
                        </div>
                        <div class="modal-body">
                            <div class="form-group">
                                <label for="auth-modal-username">Username</label>
                                <input class="form-control" id="auth-modal-username">
                            </div>
                            <div class="form-group">
                                <label for="auth-modal-password">Password</label>
                                <input type="password" class="form-control" id="auth-modal-password">
                            </div>
                            <div>
                                <h4 style="text-align: center;">OR</h4>
                            </div>
                            <div class="form-group">
                                <label for="auth-modal-token">Access token</label>
                                <input class="form-control" id="auth-modal-token">
                                <p class="help-block"><a href="https://github.com/settings/applications#personal-access-tokens" target="_blank">Generate a personal access token</a> with <i>repo</i> permission to use this web app.</p>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>
                            <button type="button" class="btn btn-primary" id="auth-modal-connect">Connect</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    
        <div class="container-fluid">
            <table class="table table-hover" id="pull-requests">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Subject</th>
                        <th>Repository</th>
                        <th>Opened</th>
                        <th>Requester</th>
                        <th class="approve"><abbr title="Code Review">CR</abbr></th>
                        <th class="verify"><abbr title="Verification">V</abbr></th>
                    </tr>
                </thead>
                <tbody>
                </tbody>
            </table>
    
            <div id="approve-legend">
                <p>Set code review status by making a comment on the pull request with <code>:+1:</code> to approve, or <code>:-1:</code> to reject.</p>
            </div>
        </div>
        
        <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.11.0/jquery.min.js"></script>
        <script src="http://netdna.bootstrapcdn.com/bootstrap/3.1.1/js/bootstrap.min.js"></script>
        <script src="http://cdnjs.cloudflare.com/ajax/libs/handlebars.js/1.3.0/handlebars.min.js"></script>
        <script src="http://cdnjs.cloudflare.com/ajax/libs/async/1.22/async.min.js"></script>
        <script src="http://cdnjs.cloudflare.com/ajax/libs/showdown/0.3.1/showdown.min.js"></script>
        <script src="Vendor/github/lib/underscore-min.js"></script>
        <script src="Vendor/github/lib/base64.js"></script>
        <script src="Vendor/github/github.js"></script>
        
        <script id="auth-not-signed-in-template" type="text/x-handlebars-template">
            <li><a href="#" class="auth-sign-in">Connect to GitHub</a></li>
        </script>
        
        <script id="auth-signed-in-template" type="text/x-handlebars-template">
            <li class="dropdown">
                <a href="#" class="dropdown-toggle" data-toggle="dropdown"><span id="username">{{user.login}}</span> <b class="caret"></b></a>
                <ul class="dropdown-menu">
                    <li><a href="#" class="auth-sign-out">Disconnect from GitHub</a></li>
                </ul>
            </li>
        </script>
        
        <script id="repos-template" type="text/x-handlebars-template">
            <li class="dropdown">
                <a href="#" class="dropdown-toggle" data-toggle="dropdown">Repositories <b class="caret"></b></a>
                <ul class="dropdown-menu">
                    {{#each owners}}
                    {{#unless @first}}<li role="presentation" class="divider"></li>{{/unless}}
                    <li role="presentation" class="dropdown-header">{{@key}}</li>
                        {{#each this}}
                        <li><a href="{{html_url}}">{{name}}</a></li>
                        {{/each}}
                    {{/each}}
                </ul>
            </li>
        </script>
        
        <script id="pull-requests-not-signed-in-template" type="text/x-handlebars-template">
            <p><a href="#" class="auth-sign-in">Connect to GitHub</a> to view all open pull requests.</p>
        </script>
        
        <script id="pull-requests-rows-template" type="text/x-handlebars-template">
            {{#each pulls}}
            <tr class="pull" id="pull-{{id}}">
                <td class="number">#{{number}}</td>
                <td class="title"><a href="{{html_url}}">{{title}}</a></td>
                <td class="repo"><a href="{{../repo.html_url}}">{{../repo.owner.login}}/{{../repo.name}}</a></td>
                <td class="opened">{{created_at_humanized}}</td>
                <td class="requester"><a href="{{user.html_url}}"><img class="gravatar" src="{{user.avatar_url}}" width="18px" height="18px" /></a> <a href="{{user.html_url}}">{{user.login}}</a></td>
                <td class="approve"><span class="text-muted">...</span></td>
                <td class="verify"><span class="text-muted">...</span></td>
            </tr>
            {{/each}}
        </script>
        
        <script>
            $(function() {
                var approveSentinels = [ ':+1:', ':v:', ':metal:' ];
                var rejectSentinels = [ ':-1:', ':poop:', ':facepunch:' ];
                
                var approveStatus = function(status, url) {
                    switch (status) {
                    case 'approved':
                        return '<a class="text-success" href="' + url + '"><span class="glyphicon glyphicon-ok"></span></a>';
                    case 'rejected':
                        return '<a class="text-danger" href="' + url + '"><span class="glyphicon glyphicon-remove"></span></a>';
                    default:
                        return '<span class="text-muted"><span class="glyphicon glyphicon-minus"></span></span>';
                    }
                };
                
                var updateApprovalStatus = function(repo_api, pull, cb) {
                    repo_api.getCommit(pull.head.sha, function(err, commit) {
                        var commit_date = commit.committer.date;
                
                        repo_api.listComments(pull.number, function(err, comments) {
                            approve_status = '';
                            approve_url = '';
                            
                            $.each(comments, function(i, comment) {
                                var comment_date = comment.updated_at;
                                if (comment_date >= commit_date) {
                                    // Get the comment text by converting it from Markdown to HTML, then stripping the HTML markup
                                    var body_html = new Showdown.converter().makeHtml(comment.body);
                                    var body = $("<div/>").html(body_html).text();
            
                                    if (approveSentinels.some(function(s) {
                                        return body.indexOf(s) >= 0;
                                    })) {
                                        approve_status = 'approved';
                                        approve_url = comment.html_url;
                                    }
                
                                    if (rejectSentinels.some(function(s) {
                                        return body.indexOf(s) >= 0;
                                    })) {
                                        approve_status = 'rejected';
                                        approve_url = comment.html_url;
                                    }
                                }
                            });
                
                            $('#pull-' + pull.id + ' .approve').html(approveStatus(approve_status, approve_url));
            
                            cb(err);
                        });
                    });
                };
                
                var verifyStatus = function(status, url) {
                    switch (status) {
                    case 'success':
                        return '<a class="text-success" href="' + url + '"><span class="glyphicon glyphicon-ok"></span></a>';
                    case 'pending':
                        return '<a class="text-warning" href="' + url + '"><span class="glyphicon glyphicon-time"></span></a>';
                    case 'error':
                    case 'failure':
                        return '<a class="text-danger" href="' + url + '"><span class="glyphicon glyphicon-remove"></span></a>';
                    default:
                        return '<span class="text-muted"><span class="glyphicon glyphicon-minus"></span></span>';
                    }
                };
                
                var updateVerificationStatus = function(repo_api, pull, cb) {
                    repo_api.listStatuses(pull.head.sha, function(err, statuses) {
                        var verify_status = '';
                        var verify_url = '';
        
                        if (statuses.length > 0) {
                            var status = statuses[0];
                            verify_status = status.state;
                            verify_url = status.target_url;
                        }
            
                        $('#pull-' + pull.id + ' .verify').html(verifyStatus(verify_status, verify_url));
    
                        cb(err);
                    });
                };
            
                var getRepoPulls = function(github_api, repo, cb) {
                    var repo_api = github_api.getRepo(repo.owner.login, repo.name);
                 
                    async.waterfall([
                        function(cb) {
                            // Get the pull requests for this repo
                            repo_api.listPulls('open', function(err, pulls) {
                                if (pulls.length > 0) {
                                    $.each(pulls, function(i, pull) {
                                        pull.created_at_humanized = new Date(Date.parse(pull.created_at)).toLocaleString();
                                    });
                                
                                    var template = Handlebars.compile($("#pull-requests-rows-template").html());
                                    $('#pull-requests tbody').append(template({
                                        repo: repo,
                                        pulls: pulls,
                                    }));
                                }
                            
                                cb(err, pulls);
                            });
                        },
                        function(pulls, cb) {
                            var tasks = [];
                        
                            $.each(pulls, function(i, pull) {
                                tasks.push(function() {
                                    updateVerificationStatus(repo_api, pull, cb);
                                });
                                tasks.push(function() {
                                    updateApprovalStatus(repo_api, pull, cb);
                                });
                            });
                        
                            async.parallel(tasks, function(err, results) {
                                cb(err);
                            });
                        },
                    ], function(err) {
                        cb(err);
                    });
                };
                
                var getRepos = function(user_api, cb) {
                    async.waterfall([
                        function(cb) {
                            // Get the user's orgs
                            user_api.orgs(function(err, orgs) {
                                cb(err, orgs);
                            });
                        },
                        function(orgs, cb) {
                            var tasks = [];
                        
                            // Get each of the user's org's repos
                            $.each(orgs, function(i, org) {
                                tasks.push(function(cb) {
                                    user_api.orgRepos(org.login, function(err, repos) {
                                        cb(err, repos);
                                    });
                                });
                            });
                        
                            // Get the user's repos
                            tasks.push(function(cb) {
                                user_api.repos(function(err, repos) {
                                    cb(err, repos);
                                });
                            });
                    
                            async.parallel(tasks, function(err, results) {
                                // Flatten the results
                                var repos = $.map(results, function(repo) {
                                    return repo;
                                }).sort(function compare(a, b) {
                                    return a.full_name.localeCompare(b.full_name);
                                });
                            
                                cb(null, repos);
                            });
                        },
                    ], function(err, repos) {
                        cb(repos);
                    });
                };
                
                var refresh = function() {
                    if ((localStorage['username'] && localStorage['password']) || localStorage['token']) {
                        $('#auth').html('<li><p class="navbar-text">Connecting...</p></li>');
                        $('#pull-requests tbody').html('');
                        
                        if (localStorage['token']) {
                            options = {
                                token: localStorage['token'],
                                auth: 'oauth',
                            };
                        } else {
                            options = {
                                username: localStorage['username'],
                                password: localStorage['password'],
                                auth: 'basic',
                            };
                        }
                
                        var github_api = new Github(options);
                
                        var user_api = github_api.getUser();
                
                        user_api.show(null, function(err, user) {
                            if (err) {
                                localStorage.removeItem('password');
                                localStorage.removeItem('token');
                                refresh();
                            } else {
                                var template = Handlebars.compile($("#auth-signed-in-template").html());
                                $('#auth').html(template({
                                    user: user,
                                }));
                
                                getRepos(user_api, function(repos) {
                                    var owners = {};
                                    $.each(repos, function(i, repo) {
                                        if (owners[repo.owner.login] == undefined) {
                                            owners[repo.owner.login] = [];
                                        }

                                        owners[repo.owner.login].push(repo);
                                    });
                                
                                    var template = Handlebars.compile($("#repos-template").html());
                                    $('#repos').html(template({
                                        owners: owners,
                                    }));
                                        
                                    async.forEach(repos, function(repo, cb) {
                                        getRepoPulls(github_api, repo, cb);
                                    });
                                });
                            }
                        });
                    } else {
                        var template = Handlebars.compile($("#auth-not-signed-in-template").html());
                        $('#auth').html(template());
                        
                        var template = Handlebars.compile($("#pull-requests-not-signed-in-template").html());
                        $('#pull-requests tbody').html(template());
                    }
                }
                $('#auth-modal').on('shown.bs.modal', function() {
                    $('#auth-modal-username').focus();
                });
                
                $(document).on('click', '.auth-sign-out', function() {
                    localStorage.removeItem('password');
                    localStorage.removeItem('token');
                    refresh();
                });
                
                $(document).on('click', '.auth-sign-in', function() {
                    $('#auth-modal-username').val(localStorage['username']);
                    $('#auth-modal-password').val('');
                    $('#auth-modal-token').val('');
                    $('#auth-modal').modal('show');
                });
                
                $(document).on('click', '#auth-modal-connect', function() {
                    localStorage['username'] = $('#auth-modal-username').val();
                    localStorage['password'] = $('#auth-modal-password').val();
                    localStorage['token'] = $('#auth-modal-token').val();
                    refresh();
                    
                    $('#auth-modal').modal('hide');
                });
                
                refresh();
            });
        </script>
    </body>
</html>
